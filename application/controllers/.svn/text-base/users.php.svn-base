<?php
/**
 * 控制器 - 用户
 */
class Users extends CI_Controller {

	/**
	 * 默认
	 */
	public function index() {
		$this->login();
	}

	/**
	 * 用户登录
	 */
	public function login() {
		// 用户已登录
		if (check_userlogin()) {
			//redirect(DEFAULT_PAGE);
		}
		
		// 接受参数
		$sReferer = $this->input->get("referer");

		// 校验参数

		$this->load->library('template');
		$this->template->assign("title", "用户 - 登录");
		$this->template->assign("referer", $sReferer);
		$this->template->view('users/login');
	}

	/**
	 * 处理登录
	 */
	public function do_login() {
		// 接受数据
		$iAjax		= $this->input->get_post("aj");				// 是否是ajax请求
		$sLoginName	= $this->input->post("loginname");			// 登录名
		$sPassword	= $this->input->post("password");			// 密码
		$sReferer	= $this->input->post("referer");			// referer
		$sReferer	= empty($sReferer) ? DEFAULT_PAGE : $sReferer;
		$sRememerLogin	= $this->input->post("");

		// 校验数据格式
		$this->load->helper("notice");
		if (empty($sLoginName) || empty($sPassword)) {
			show_message(MSG_001, "MSG_001", false, "users/login", $iAjax);
		}

		// 检查数据
		$this->load->model('Common_Model');
		$this->Common_Model->setParam(T_USER, "id");
		$aWhere["username"] = $sLoginName;
		$aUserInfo = $this->Common_Model->getInfoByField($aWhere);
		if (!$aUserInfo) {
			show_message(MSG_002, "MSG_002", false, "users/login", $iAjax);
		} else {
			// 检查用户状态

			if ($sPassword == $aUserInfo["password"]) {
				// cookie\session保存
				$iExpireTime = time() + CK_EXPIRE_TIME;
				set_cookie(CK_USERID, $auserInfo["id"], $iExpireTime);
				set_cookie(CK_EXPIRE, $iExpireTime, $iExpireTime);
				// 加密串保存
				$sUserIP = getIP();
				$sSecString = hashCookie($sUserID, $iExpireTime, $sUserIP);
				$this->Common_Model->saveInfo(array("expire_string" => $sSecString), $aUserInfo["id"]);

				session_start();
				$_SESSION[CK_USERID] = $auserInfo["id"];
				$_SESSION[CK_USERNAME] = $sLoginName;

				if ($iAjax == 1) {
					show_message(MSG_OK, "MSG_OK", true, "users/login", $iAjax);
				} else {
					redirect($sReferer);
				}
			} else {
				show_message(MSG_003, "MSG_003", false, "users/login", $iAjax);
			}
		}
	}

	/**
	 * 用户退出
	 */
	public function logout() {
		// 删除cookie
		delete_cookie(CK_USERID);
		delete_cookie(CK_EXPIRE);
		// 删除session
		session_unset();
	}

	/**
	 * 用户注册
	 */
	public function register() {
		$this->load->library('template');
		$this->template->assign("title", "用户 - 注册");
		$this->template->view('users/register');
	}

	public function do_register() {
		// 接受参数
		$email	= $this->input->post("email");
		$nick	= $this->input->post("nick");
		$pwd	= $this->input->post("pwd");
		$pwd2	= $this->input->post("pwd2");

		// 参数校验
		
		
		// 写入数据库
		$aData = array(
			"username"		=> mysql_escape_string($email),
			"realname"		=> mysql_escape_string($nick),
			"password"		=> md5($pwd),
		);
		$this->load->model("Users_model");
		$this->Users_model->saveInfo($aData);

		header("Location: /users");
	}
}

?>
